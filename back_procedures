WITH procedure_claims as
(
SELECT
distinct CLAIM_ID,
procedure.procedure_raw_code as procedure_code,
procedure.procedure_primary_display as procedure
FROM ph_f_procedure procedure
WHERE
procedure.procedure_raw_code in ( select procedure_code::varchar from BACK_AND_SPINE_W_SUPER_CLASS
)
--procedure.procedure_raw_code in ('98940', '98941','98942','98943')

AND SOURCE_DESCRIPTION ILIKE('%cms%')
and year(procedure.SERVICE_start_DATE::date) = 2018
--group by claim_id
)
SELECT
b.procedure_super_class
,count(distinct(claim.empi_id)) as Number_of_Patients
,count(distinct(claim.claim_id)) as Number_of_Claims
---,count(claim.claim_id) as Num_of_Claims
,sum(TOTAL_PAID_CHARGE) as paid_Amount
,sum(TOTAL_PAID_CHARGE)/ count(distinct(claim.claim_id)) as Avg_Paid_per_Claim
,sum(TOTAL_PAID_CHARGE)/ count(distinct(claim.empi_id)) as Avg_Paid_per_Patient
,count(distinct(claim.claim_id))/ count(distinct(claim.empi_id)) as Per_Patient_Utilization
from ph_f_annotated_claim claim
INNER JOIN procedure_claims on CLAIM.CLAIM_ID = procedure_claims.claim_id
INNER JOIN BACK_AND_SPINE_W_SUPER_CLASS b on b.procedure_code = procedure_claims.procedure_code
WHERE SOURCE_DESCRIPTION ILIKE('%cms%')
Group by  1--,2,3--,2 -- ,2
order by paid_amount DESC
;
